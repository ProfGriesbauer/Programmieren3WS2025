using System;
using System.Windows.Input;

namespace OOPGames
{
	// Einfacher Human-Player für B5 TicTacToe.
	// Wenn ein Feld angeklickt wird, liefert GetMove ein B5_TicTacToeMove zurück.
	public class B5_TicTacToePlayer : IHumanGamePlayer, IHumanGamePlayerWithMouse
	{
		public string Name => "B5 TicTacToe Player";

		public int PlayerNumber { get; private set; }

		public bool CanBeRuledBy(IGameRules rules)
		{
			return rules is B5_GameRules;
		}

		public IGamePlayer Clone()
		{
			B5_TicTacToePlayer clone = new B5_TicTacToePlayer();
			clone.SetPlayerNumber(PlayerNumber);
			return clone;
		}

		// Wandelt eine Click-Selection in eine Board-Position um und gibt den Zug zurück.
		// Benutzt dieselbe Logik wie andere Gruppen: feste Zellengröße 100x100 Pixel.
		public IPlayMove GetMove(IMoveSelection selection, IGameField field)
		{
			if (!(selection is IClickSelection click)) return null;

			// Versuche Canvas-Größe aus der Selection (falls implementiert)
			double canvasW = 300.0, canvasH = 300.0;
			try
			{
				var selType = click.GetType();
				var propW = selType.GetProperty("CanvasWidth");
				var propH = selType.GetProperty("CanvasHeight");
				if (propW != null && propH != null)
				{
					var valW = propW.GetValue(click);
					var valH = propH.GetValue(click);
					canvasW = valW != null ? Convert.ToDouble(valW) : canvasW;
					canvasH = valH != null ? Convert.ToDouble(valH) : canvasH;
				}
			}
			catch { }

			// Fallback: Versuche das PaintCanvas aus dem MainWindow zu holen
			if (canvasW == 300.0 && canvasH == 300.0)
			{
				try
				{
					var app = System.Windows.Application.Current;
					var main = app?.MainWindow;
					var canvas = main?.FindName("PaintCanvas") as System.Windows.Controls.Canvas;
					if (canvas != null)
					{
						canvasW = canvas.ActualWidth > 0 ? canvas.ActualWidth : (canvas.Width > 0 ? canvas.Width : canvasW);
						canvasH = canvas.ActualHeight > 0 ? canvas.ActualHeight : (canvas.Height > 0 ? canvas.Height : canvasH);
					}
				}
				catch { }
			}

			// Berechne Zellengröße entsprechend Painter (B5_TicTacToePaint verwendet canvas.ActualWidth/3)
			double cellW = canvasW / 3.0;
			double cellH = canvasH / 3.0;

			// Bestimme Zeile/Spalte anhand der Klickposition (double -> int)
			int row = (int)(click.YClickPos / cellH);
			int col = (int)(click.XClickPos / cellW);

			if (row >= 0 && row < 3 && col >= 0 && col < 3)
			{
				if (field is IB5_TicTacToeField ticField && ticField.GetFieldValue(row, col) == 0)
				{
					return new B5_TicTacToeMove(PlayerNumber, row, col);
				}
			}

			return null;
		}

		public void SetPlayerNumber(int playerNumber)
		{
			PlayerNumber = playerNumber;
		}

		// Optionale Unterstützung für Mausbewegungen (hier: keine Vorschau, leer)
		public void OnMouseMoved(MouseEventArgs e)
		{
			// Intentionally left blank: no hover preview required for this simple player.
		}
	}
}

