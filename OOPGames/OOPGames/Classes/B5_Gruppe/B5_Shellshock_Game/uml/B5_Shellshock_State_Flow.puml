@startuml B5_Shellshock_State_Flow

title B5 Shellshock - Game State Machine & Flow\n(State Diagram with Transitions)

skinparam backgroundColor #FEFEFE
skinparam roundcorner 10
skinparam state {
    BackgroundColor<<Setup>> LightBlue
    BackgroundColor<<PlayerTurn>> LightGreen
    BackgroundColor<<Flight>> Yellow
    BackgroundColor<<GameOver>> LightCoral
    BorderColor Black
    FontSize 12
}

[*] --> Setup : Game Initialized

state "Setup" as Setup <<Setup>> {
    Setup : **Initial State**
    Setup : ──────────────
    Setup : • Display start screen
    Setup : • Show controls & instructions
    Setup : • Wait for player input
    Setup : ──────────────
    Setup : **Valid Actions:**
    Setup : • Press Space/Click → Start Game
}

state "PlayerTurn" as PlayerTurn <<PlayerTurn>> {
    PlayerTurn : **Active Gameplay**
    PlayerTurn : ──────────────
    PlayerTurn : • Current player controls tank
    PlayerTurn : • Movement limited (per turn)
    PlayerTurn : • Adjust angle & power
    PlayerTurn : ──────────────
    PlayerTurn : **Valid Actions:**
    PlayerTurn : • A/D: Move tank (if moves remain)
    PlayerTurn : • W/S: Adjust firing angle
    PlayerTurn : • Q/E: Adjust shot power
    PlayerTurn : • Space/Click: Shoot
    PlayerTurn : ──────────────
    PlayerTurn : **State Data:**
    PlayerTurn : • ActiveTankNumber (1 or 2)
    PlayerTurn : • MovementsRemaining (0-3)
    PlayerTurn : • Tank.Angle [0-180°]
    PlayerTurn : • Tank.Power [0-100]
}

state "ProjectileInFlight" as Flight <<Flight>> {
    Flight : **Physics Simulation**
    Flight : ──────────────
    Flight : • Projectile active & flying
    Flight : • Physics tick every 40ms
    Flight : • No player input accepted
    Flight : ──────────────
    Flight : **Continuous Updates:**
    Flight : • UpdatePosition(gravity, wind, dt)
    Flight : • Record trajectory points
    Flight : • Check collisions each tick
    Flight : ──────────────
    Flight : **Collision Detection:**
    Flight : • Terrain collision → Crater
    Flight : • Tank collision → Damage (-20 HP)
    Flight : • HealthPack collision → Heal (+25 HP)
    Flight : • Out of bounds → Miss
}

state "GameOver" as GameOver <<GameOver>> {
    GameOver : **End State**
    GameOver : ──────────────
    GameOver : • One tank destroyed (HP = 0)
    GameOver : • Display winner
    GameOver : • Show final stats
    GameOver : ──────────────
    GameOver : **Valid Actions:**
    GameOver : • Press Space → Restart
}

' ════════════════════════════════════════════════════════════
' TRANSITIONS
' ════════════════════════════════════════════════════════════

Setup --> PlayerTurn : **[Space/Click pressed]**\nDoMove(StartGame)\n• Generate terrain\n• Initialize tanks\n• Set ActiveTank = 1

PlayerTurn --> Flight : **[Space/Click pressed]**\nDoMove(Shoot)\n• tank.Fire(playerNumber)\n• Create projectile at barrel end\n• Clear old trajectory\n• Set _pendingTurnSwitch = true

Flight --> PlayerTurn : **[Projectile collision]**\nTickGameCall() detects collision\n• Deactivate projectile\n• Apply damage/healing\n• Destroy terrain (if ground hit)\n• Switch turn (1 ↔ 2)\n• Reset movements to 3\n• Randomize wind\n• Spawn health pack (50% chance)\n• Check win condition → If no winner

Flight --> GameOver : **[Tank destroyed]**\nTickGameCall() checks health\n• Tank.Health = 0\n• CheckIfPlayerWon() returns winner\n• Display victory screen

GameOver --> PlayerTurn : **[Space/Click pressed]**\nDoMove(StartGame)\n• ClearField()\n• Reset all state\n• New terrain\n• Tanks restored

' ════════════════════════════════════════════════════════════
' INTERNAL TRANSITIONS (STATE BEHAVIOR)
' ════════════════════════════════════════════════════════════

PlayerTurn --> PlayerTurn : **[Movement/Aim/Power]**\nDoMove(MoveLeft/Right/AngleUp/Down/Power)\n• Update tank position/angle/power\n• Decrement MovementsRemaining\n• Keep same player (_lastMoveKeepsTurn = true)

Flight --> Flight : **[Every 40ms tick]**\nTickGameCall() while projectile active\n• UpdatePosition(gravity, wind, dt)\n• Record trajectory point\n• Check collisions (loop continues)\n• Render updated position

' ════════════════════════════════════════════════════════════
' NOTES
' ════════════════════════════════════════════════════════════

note right of Setup
  **Initialization:**
  
  Rules constructor:
  • _gamePhase = Setup
  • _activeTankNumber = 1
  • _movementsRemaining = 3
  
  Field constructor:
  • Generate random terrain
  • Create Tank1 & Tank2
  • Initialize wind
end note

note left of PlayerTurn
  **Turn Management:**
  
  Each player has:
  • 3 movements per turn
  • Unlimited angle/power adjustments
  • 1 shot (ends turn)
  
  Movement/Aim/Power:
  • _lastMoveKeepsTurn = **true**
  • Same player continues
  
  Shoot:
  • _lastMoveKeepsTurn = **false**
  • _pendingTurnSwitch = **true**
  • Turn switches after collision
end note

note right of Flight
  **Physics Simulation:**
  
  UpdatePosition() called every 40ms:
  • velocityY += gravity * dt * powerNorm
  • X += velocityX * dt + wind * dt
  • Y += velocityY * dt
  
  Collision checks (in order):
  1. Terrain.IsCollision(x, y)
     → DestroyTerrain(x, radius=30)
  2. Tank1.CollidesWith(projectile)
     → TakeDamage(20)
  3. Tank2.CollidesWith(projectile)
     → TakeDamage(20)
  4. HealthPack.CollidesWith(projectile)
     → Heal(25), Deactivate pack
  5. Out of bounds (x<0 || x>width || y>1.0)
  
  **After collision:**
  • Switch active tank (1 ↔ 2)
  • Reset movements to 3
  • Randomize wind (-5 to +5)
  • 50% chance spawn health pack
end note

note left of GameOver
  **Win Condition:**
  
  CheckIfPlayerWon() returns:
  • **1** if Tank2.Health = 0 (Player 1 wins)
  • **2** if Tank1.Health = 0 (Player 2 wins)
  • **-1** if both tanks alive (continue)
  
  Victory screen shows:
  • Winner name
  • "Press Space to restart"
end note

' ════════════════════════════════════════════════════════════
' STATE MACHINE DATA
' ════════════════════════════════════════════════════════════

note as StateData
  **State Machine Variables (in Rules):**
  
  **_gamePhase** : B5_Shellshock_GamePhase
    - Setup
    - PlayerTurn
    - ProjectileInFlight
    - GameOver
  
  **_activeTankNumber** : int (1 or 2)
  **_movementsRemaining** : int (0-3)
  **_pendingTurnSwitch** : bool
  **_lastMoveKeepsTurn** : bool (for framework)
  
  **Synchronized to Field:**
  _field.GamePhase = _gamePhase
  _field.ActiveTankNumber = _activeTankNumber
  _field.MovementsRemaining = _movementsRemaining
end note

' ════════════════════════════════════════════════════════════
' DECISION POINTS
' ════════════════════════════════════════════════════════════

state CollisionCheck <<choice>>
state WinCheck <<choice>>

Flight --> CollisionCheck : Collision detected?
CollisionCheck --> PlayerTurn : [No winner]\nBoth tanks alive
CollisionCheck --> WinCheck : Check tank health
WinCheck --> GameOver : [Tank.Health = 0]\nWinner determined
WinCheck --> PlayerTurn : [Both alive]\nContinue game

' ════════════════════════════════════════════════════════════
' LEGEND
' ════════════════════════════════════════════════════════════

legend bottom right
  **Game State Flow:**
  
  **State Types:**
  • <back:LightBlue>Setup</back> - Initialization & start screen
  • <back:LightGreen>PlayerTurn</back> - Active gameplay, player input
  • <back:Yellow>ProjectileInFlight</back> - Physics simulation
  • <back:LightCoral>GameOver</back> - End screen, restart option
  
  **Key Transitions:**
  • Shoot → Creates projectile, enters Flight state
  • Collision → Applies effects, switches turn
  • Tank destroyed → Enters GameOver state
  
  **Turn Switching:**
  Movement/Aim/Power keep turn (same player)
  Shoot ends turn (switches after collision)
  
  **Framework Integration:**
  • DoMove() handles state transitions
  • TickGameCall() updates Flight state (40ms)
  • _lastMoveKeepsTurn tells framework whether to switch players
end legend

@enduml
